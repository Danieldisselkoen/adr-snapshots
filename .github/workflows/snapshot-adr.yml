name: ADR Hourly Snapshots

on:
  schedule:
    - cron: '0 * * * *'

  workflow_dispatch:
    inputs:
      domains:
        description: 'Comma-separated domains to snapshot (leave empty for all)'
        required: false
        type: string

      force_cleanup:
        description: 'Clean slate - Remove ALL previous snapshots from repository'
        required: false
        type: boolean
        default: false

jobs:
  snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout snapshots repository (sparse - only JSON files)
        uses: actions/checkout@v3
        with:
          sparse-checkout: |
            *.json
            .github
          sparse-checkout-cone-mode: false

      - name: Clone private code repository
        run: |
          git clone https://github-actions:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/Danieldisselkoen/adr-brandguide.git ../adr-brandguide
          echo "Successfully cloned private repository"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd ../adr-brandguide
          npm ci
          npm install puppeteer

      - name: Force cleanup of existing snapshots (if requested)
        if: github.event.inputs.force_cleanup == 'true'
        run: |
          echo "Force cleanup enabled - preparing clean slate..."
          find . -name "*.webp" -delete 2>/dev/null || true
          find . -name "*.png" -delete 2>/dev/null || true
          find . -name "metadata.json" -delete 2>/dev/null || true
          rm -rf ad.nl bd.nl bndestem.nl destentor.nl ed.nl gelderlander.nl pzc.nl tubantia.nl 2>/dev/null || true
          find . -maxdepth 1 -name "*.json" -delete 2>/dev/null || true
          rm -rf domain-indexes 2>/dev/null || true
          echo "Cleanup complete"

      - name: Create snapshots directory
        run: |
          cd ../adr-brandguide
          mkdir -p snapshots

      - name: Take snapshots
        run: |
          cd ../adr-brandguide
          export TZ=Europe/Amsterdam
          SNAPSHOT_TIME=$(date +"%H-%M")
          SNAPSHOT_DATE=$(date +"%Y-%m-%d")
          SNAPSHOT_TIMESTAMP=$(date +"%Y-%m-%dT%H:%M:%S%z")

          echo "Starting snapshots at $SNAPSHOT_DATE $SNAPSHOT_TIME"

          echo "$SNAPSHOT_TIME" > snapshot_time.txt
          echo "$SNAPSHOT_DATE" > snapshot_date.txt
          echo "$SNAPSHOT_TIMESTAMP" > snapshot_timestamp.txt

          if [ -n "${{ github.event.inputs.domains }}" ]; then
            node scripts/snapshot-multi.js "${{ github.event.inputs.domains }}" --time="$SNAPSHOT_TIME" --date="$SNAPSHOT_DATE" --timestamp="$SNAPSHOT_TIMESTAMP"
          else
            node scripts/snapshot-multi.js --time="$SNAPSHOT_TIME" --date="$SNAPSHOT_DATE" --timestamp="$SNAPSHOT_TIMESTAMP"
          fi
        timeout-minutes: 10

      - name: Generate snapshots manifest and latest.json
        run: |
          cd ../adr-brandguide
          export TZ=Europe/Amsterdam

          if [ -f "snapshot_time.txt" ] && [ -f "snapshot_date.txt" ] && [ -f "snapshot_timestamp.txt" ]; then
            SNAPSHOT_TIME=$(cat snapshot_time.txt)
            SNAPSHOT_DATE=$(cat snapshot_date.txt)
            SNAPSHOT_TIMESTAMP=$(cat snapshot_timestamp.txt)
            echo "Using timestamps from snapshot step: $SNAPSHOT_DATE $SNAPSHOT_TIME"
          else
            SNAPSHOT_TIME=$(date +"%H-%M")
            SNAPSHOT_DATE=$(date +"%Y-%m-%d")
            SNAPSHOT_TIMESTAMP=$(date +"%Y-%m-%dT%H:%M:%S%z")
            echo "Fallback: generating new timestamps: $SNAPSHOT_DATE $SNAPSHOT_TIME"
          fi

          DISPLAY_TIME="${SNAPSHOT_TIME//-/:}"

          if [ -f "snapshots/snapshots-index.json" ]; then
            EXISTING_DATE=$(grep -o '"date": *"[^"]*"' snapshots/snapshots-index.json | head -1 | sed 's/"date": *"\([^"]*\)"/\1/')

            if [ "$EXISTING_DATE" = "$SNAPSHOT_DATE" ]; then
              echo "Found existing snapshots for $SNAPSHOT_DATE, adding new timestamp..."
              node -e "
                const fs = require('fs');
                const existing = JSON.parse(fs.readFileSync('snapshots/snapshots-index.json', 'utf8'));
                const newSnapshot = {
                  time: '$SNAPSHOT_TIME',
                  timestamp: '$SNAPSHOT_TIMESTAMP',
                  displayTime: '$DISPLAY_TIME',
                  domains: ['ad.nl', 'pzc.nl', 'ed.nl', 'bd.nl', 'destentor.nl', 'gelderlander.nl', 'tubantia.nl', 'bndestem.nl']
                };
                const existingIndex = existing.snapshots.findIndex(s => s.time === '$SNAPSHOT_TIME');
                if (existingIndex >= 0) {
                  existing.snapshots[existingIndex] = newSnapshot;
                } else {
                  existing.snapshots.push(newSnapshot);
                }
                existing.snapshots.sort((a, b) => a.time.localeCompare(b.time));
                fs.writeFileSync('snapshots/snapshots-index.json', JSON.stringify(existing, null, 2));
              "
            else
              echo "Different date found, creating new index..."
              echo "{\"date\":\"$SNAPSHOT_DATE\",\"snapshots\":[{\"time\":\"$SNAPSHOT_TIME\",\"timestamp\":\"$SNAPSHOT_TIMESTAMP\",\"displayTime\":\"$DISPLAY_TIME\",\"domains\":[\"ad.nl\",\"pzc.nl\",\"ed.nl\",\"bd.nl\",\"destentor.nl\",\"gelderlander.nl\",\"tubantia.nl\",\"bndestem.nl\"]}]}" > snapshots/snapshots-index.json
            fi
          else
            echo "No existing snapshots-index.json found, creating new one..."
            echo "{\"date\":\"$SNAPSHOT_DATE\",\"snapshots\":[{\"time\":\"$SNAPSHOT_TIME\",\"timestamp\":\"$SNAPSHOT_TIMESTAMP\",\"displayTime\":\"$DISPLAY_TIME\",\"domains\":[\"ad.nl\",\"pzc.nl\",\"ed.nl\",\"bd.nl\",\"destentor.nl\",\"gelderlander.nl\",\"tubantia.nl\",\"bndestem.nl\"]}]}" > snapshots/snapshots-index.json
          fi

          cp snapshots/snapshots-index.json "snapshots/snapshots-$SNAPSHOT_DATE.json"
          echo "Created date-specific index: snapshots-$SNAPSHOT_DATE.json"

          echo "{\"timestamp\":\"$SNAPSHOT_TIMESTAMP\",\"date\":\"$SNAPSHOT_DATE\",\"time\":\"$SNAPSHOT_TIME\",\"displayTime\":\"$DISPLAY_TIME\",\"domains\":[\"ad.nl\",\"pzc.nl\",\"ed.nl\",\"bd.nl\",\"destentor.nl\",\"gelderlander.nl\",\"tubantia.nl\",\"bndestem.nl\"],\"status\":\"completed\"}" > snapshots/latest.json

          echo "Generated manifest files for $SNAPSHOT_DATE $SNAPSHOT_TIME"

      - name: Copy snapshots and commit
        run: |
          echo "Copying snapshots to repository..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          SNAPSHOT_DATE_FOR_MERGE=$(cat ../adr-brandguide/snapshot_date.txt 2>/dev/null || date +"%Y-%m-%d")

          if [ -f "snapshots-index.json" ]; then
            echo "Found existing snapshots-index.json in repository, merging..."
            cp snapshots-index.json ../adr-brandguide/snapshots/existing-snapshots-index.json
          fi

          if [ -f "snapshots-$SNAPSHOT_DATE_FOR_MERGE.json" ]; then
            echo "Found existing date-specific index for $SNAPSHOT_DATE_FOR_MERGE, merging..."
            cp "snapshots-$SNAPSHOT_DATE_FOR_MERGE.json" "../adr-brandguide/snapshots/existing-date-specific.json"
          fi

          cd ../adr-brandguide
          node -e "
            const fs = require('fs');
            const snapshotDate = '$SNAPSHOT_DATE_FOR_MERGE';
            const newData = JSON.parse(fs.readFileSync('snapshots/snapshots-index.json', 'utf8'));
            let existing = { date: snapshotDate, snapshots: [] };
            if (fs.existsSync('snapshots/existing-date-specific.json')) {
              existing = JSON.parse(fs.readFileSync('snapshots/existing-date-specific.json', 'utf8'));
            } else if (fs.existsSync('snapshots/existing-snapshots-index.json')) {
              const existingGeneral = JSON.parse(fs.readFileSync('snapshots/existing-snapshots-index.json', 'utf8'));
              if (existingGeneral.date === snapshotDate) {
                existing = existingGeneral;
              }
            }
            if (existing.date === newData.date) {
              for (const existingSnapshot of existing.snapshots) {
                const existsInNew = newData.snapshots.find(s => s.time === existingSnapshot.time);
                if (!existsInNew) {
                  newData.snapshots.push(existingSnapshot);
                }
              }
              newData.snapshots.sort((a, b) => a.time.localeCompare(b.time));
            }
            fs.writeFileSync('snapshots/snapshots-index.json', JSON.stringify(newData, null, 2));
            fs.writeFileSync('snapshots/snapshots-' + newData.date + '.json', JSON.stringify(newData, null, 2));
          "
          cd ../${{ github.event.repository.name }}

          if [ -d "../adr-brandguide/snapshots" ] && [ "$(ls -A ../adr-brandguide/snapshots 2>/dev/null)" ]; then
            cp -r ../adr-brandguide/snapshots/* . 2>/dev/null || echo "Failed to copy snapshots"
            rm -f existing-snapshots-index.json existing-date-specific.json 2>/dev/null || true
            git add --sparse .
            SNAPSHOT_TIME_FOR_COMMIT=$(cat ../adr-brandguide/snapshot_time.txt 2>/dev/null || echo "unknown")
            SNAPSHOT_DATE_FOR_COMMIT=$(cat ../adr-brandguide/snapshot_date.txt 2>/dev/null || echo "unknown")
            DISPLAY_TIME="${SNAPSHOT_TIME_FOR_COMMIT//-/:}"
            COMMIT_MSG="Add snapshots from $SNAPSHOT_DATE_FOR_COMMIT $DISPLAY_TIME"
            if git commit -m "$COMMIT_MSG"; then
              git push
              echo "Snapshots pushed successfully"
            else
              echo "No changes to commit"
            fi
          else
            echo "No snapshots directory found"
          fi

      - name: Upload artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-logs
          path: |
            global-index.json
            domain-indexes/*.json
          retention-days: 1

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: echo "Snapshot workflow failed at $(date)"
